<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Range Ball iButton Analyzer</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            color: #00d4aa;
            text-align: center;
        }
        h2 {
            color: #00d4aa;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .section {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 14px;
        }
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 5px;
            background: #0f0f23;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 15px;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        button {
            background: #00d4aa;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #00b894;
        }
        button.secondary {
            background: #4a5568;
            color: #fff;
        }
        button.secondary:hover {
            background: #5a6578;
        }
        .byte-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        .byte-cell {
            background: #0f0f23;
            padding: 10px 5px;
            text-align: center;
            border-radius: 5px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .byte-cell:hover {
            border-color: #00d4aa;
        }
        .byte-cell.selected {
            border-color: #ff6b6b;
            background: #2d1b1b;
        }
        .byte-cell.highlight {
            border-color: #ffd93d;
            background: #2d2a1b;
        }
        .byte-index {
            font-size: 10px;
            color: #666;
        }
        .byte-hex {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            color: #00d4aa;
        }
        .byte-dec {
            font-size: 11px;
            color: #888;
        }
        .info-box {
            background: #0f0f23;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #888;
        }
        .info-value {
            font-weight: bold;
            color: #00d4aa;
            font-family: 'Courier New', monospace;
        }
        .uses-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #1a472a, #0f0f23);
            border-radius: 10px;
            margin: 20px 0;
        }
        .credits-row {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        .credit-box {
            text-align: center;
        }
        .uses-number {
            font-size: 72px;
            font-weight: bold;
            color: #00d4aa;
        }
        .uses-label {
            font-size: 18px;
            color: #888;
        }
        .edit-section {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #333;
        }
        .edit-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .edit-row label {
            margin-bottom: 0;
            min-width: 100px;
        }
        .edit-row input {
            width: 100px;
            margin-bottom: 0;
        }
        .output-box {
            background: #0f0f23;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid #333;
        }
        .warning {
            background: #2d2a1b;
            border-left: 4px solid #ffd93d;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        .rom-display {
            font-family: 'Courier New', monospace;
            color: #888;
        }
        .copy-btn {
            background: #4a5568;
            padding: 8px 16px;
            font-size: 12px;
        }
        .success {
            color: #00d4aa;
        }
    </style>
</head>
<body>
    <h1>üèåÔ∏è Range Ball iButton Analyzer</h1>
    
    <div class="section">
        <h2>ÔøΩ Compare Two iButtons</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>Button A (e.g., before use):</label>
                <textarea id="compareA" style="height: 120px;" placeholder="Paste first iButton data...">Filetype: Flipper iButton key
Version: 2
Protocol: DS1971
Rom Data: 14 CE F7 9A 09 00 00 00
Eeprom Data: 0E BF 99 00 01 01 30 02 00 24 CE 00 00 00 00 FC C9 FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</textarea>
            </div>
            <div>
                <label>Button B (e.g., after use or different button):</label>
                <textarea id="compareB" style="height: 120px;" placeholder="Paste second iButton data...">Filetype: Flipper iButton key
Version: 2
Protocol: DS1971
Rom Data: 14 E2 9C 9A 09 00 00 AA
Eeprom Data: 0E BF 99 00 01 01 E0 01 00 A1 D0 00 00 00 00 96 8E FF FF FF FF FF FF FF FF FF FF EF FF FF FF FF</textarea>
            </div>
        </div>
        <button onclick="compareButtons()">üîç Compare</button>
        <div id="compareResults" style="margin-top: 15px;"></div>
    </div>

    <div class="section">
        <h2>ÔøΩüì• Input Flipper Zero Data</h2>
        <label>Paste your complete Flipper iButton file or just the EEPROM data:</label>
        <textarea id="inputData" placeholder="Paste Flipper iButton data here...">Filetype: Flipper iButton key
Version: 2
Protocol: DS1971
Rom Data: 14 CE F7 9A 09 00 00 00
Eeprom Data: 0E BF 99 00 01 01 30 02 00 24 CE 00 00 00 00 FC C9 FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</textarea>
        <button onclick="parseData()">üîç Analyze</button>
        <button class="secondary" onclick="clearAll()">Clear</button>
    </div>

    <div class="section" id="resultsSection" style="display: none;">
        <h2>üìä Analysis Results</h2>
        
        <div id="romInfo" class="info-box">
            <div class="info-row">
                <span class="info-label">Protocol:</span>
                <span class="info-value" id="protocol">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">ROM Data:</span>
                <span class="info-value rom-display" id="romData">-</span>
            </div>
        </div>

        <div class="uses-display">
            <div class="uses-label">Credits Remaining</div>
            <div class="credits-row">
                <div class="credit-box">
                    <div class="uses-number" id="usesDisplay">--</div>
                    <div class="uses-label">credits</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                <div style="color: #888; font-size: 14px;">Bucket equivalents:</div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                    <span>ü™£ Small (1 credit):</span>
                    <span id="smallBuckets" style="color: #00d4aa; font-weight: bold;">--</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                    <span>ü™£ Medium (2 credits):</span>
                    <span id="mediumBuckets" style="color: #00d4aa; font-weight: bold;">--</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                    <span>ü™£ Large (3 credits):</span>
                    <span id="largeBuckets" style="color: #00d4aa; font-weight: bold;">--</span>
                </div>
            </div>
            <div class="uses-label" id="usesExplanation" style="margin-top: 15px;"></div>
        </div>

        <div class="info-box" style="border-left: 4px solid #00d4aa;">
            <strong>‚úÖ Checksum Validation:</strong>
            <div id="checksumStatus" style="margin-top: 8px;">--</div>
        </div>

        <h3>EEPROM Memory Map (click to select)</h3>
        <div class="byte-grid" id="byteGrid"></div>
        
        <div class="info-box">
            <strong>Legend:</strong><br>
            <span style="color: #ffd93d;">‚ñ†</span> Yellow border = Credit counter (bytes 6-7)<br>
            <span style="color: #00d4aa;">‚ñ†</span> Green border = Session counter (bytes 9-10)<br>
            <span style="color: #ff6b6b;">‚ñ†</span> Red border = Checksum (bytes 15-16)
        </div>
    </div>

    <div class="section" id="editSection" style="display: none;">
        <h2>‚úèÔ∏è Modify Credits</h2>
        
        <div class="info-box">
            ‚úÖ <strong>Confirmed Formula:</strong> Credits stored in bytes 6-7 as little-endian.<br>
            <code>raw_value = credits √ó 20</code><br>
            Fresh ball = 30 credits (600 raw = 0x0258)
        </div>

        <div class="edit-section">
            <h4>Quick Set Credits:</h4>
            <button onclick="setCreditsQuick(30)">30 Credits (Fresh)</button>
            <button onclick="setCreditsQuick(25)">25 Credits</button>
            <button onclick="setCreditsQuick(20)">20 Credits</button>
            <button onclick="setCreditsQuick(10)">10 Credits</button>
            <hr style="border-color: #333; margin: 15px 0;">
            <div class="edit-row">
                <label>Custom Credits:</label>
                <input type="number" id="newCredits" value="30" min="0" max="100">
                <button onclick="setCredits()">Set Credits</button>
            </div>
            <p style="color: #888; font-size: 12px; margin-top: 10px;">‚ö†Ô∏è Checksum bytes (15-16) will be auto-calculated</p>
        </div>
    </div>

    <div class="section" id="outputSection" style="display: none;">
        <h2>üì§ Output for Flipper Zero</h2>
        
        <label>Modified EEPROM Data (copy this):</label>
        <div class="output-box" id="outputEeprom"></div>
        <button class="copy-btn" onclick="copyEeprom()">üìã Copy EEPROM</button>
        <br><br>
        
        <label>Complete Flipper iButton File:</label>
        <div class="output-box" id="outputFull"></div>
        <button class="copy-btn" onclick="copyFull()">üìã Copy Full File</button>
        <button class="copy-btn" onclick="downloadFile()">üíæ Download .ibtn File</button>
        
        <div id="copyStatus" style="margin-top: 10px;"></div>
    </div>

    <div class="section">
        <h2>üî¨ How This Works</h2>
        <p>This tool analyzes DS1971 iButton EEPROM data used in golf range ball dispensers.</p>
        
        <h4>‚úÖ Confirmed Format (Reverse Engineered):</h4>
        <ul>
            <li><strong>Bytes 6-7:</strong> Credit counter (little-endian, value = credits √ó 20)</li>
            <li><strong>Bytes 9-10:</strong> Session/use counter (changes each dispense)</li>
            <li><strong>Bytes 15-16:</strong> Checksum bytes (validated by dispenser)</li>
        </ul>
        
        <h4>üìã Credit Values Reference:</h4>
        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
            <tr style="background: #0f0f23;">
                <th style="padding: 8px; border: 1px solid #333;">Credits</th>
                <th style="padding: 8px; border: 1px solid #333;">Raw Value</th>
                <th style="padding: 8px; border: 1px solid #333;">Bytes 6-7 (LE)</th>
                <th style="padding: 8px; border: 1px solid #333;">Buckets</th>
            </tr>
            <tr><td style="padding: 8px; border: 1px solid #333;">30 (Fresh)</td><td style="padding: 8px; border: 1px solid #333;">600 (0x0258)</td><td style="padding: 8px; border: 1px solid #333;">58 02</td><td style="padding: 8px; border: 1px solid #333;">30S / 15M / 10L</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #333;">24</td><td style="padding: 8px; border: 1px solid #333;">480 (0x01E0)</td><td style="padding: 8px; border: 1px solid #333;">E0 01</td><td style="padding: 8px; border: 1px solid #333;">24S / 12M / 8L</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #333;">23</td><td style="padding: 8px; border: 1px solid #333;">460 (0x01CC)</td><td style="padding: 8px; border: 1px solid #333;">CC 01</td><td style="padding: 8px; border: 1px solid #333;">23S / 11M / 7L</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #333;">20</td><td style="padding: 8px; border: 1px solid #333;">400 (0x0190)</td><td style="padding: 8px; border: 1px solid #333;">90 01</td><td style="padding: 8px; border: 1px solid #333;">20S / 10M / 6L</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #333;">10</td><td style="padding: 8px; border: 1px solid #333;">200 (0x00C8)</td><td style="padding: 8px; border: 1px solid #333;">C8 00</td><td style="padding: 8px; border: 1px solid #333;">10S / 5M / 3L</td></tr>
        </table>

        <h4>üîê Checksum Formulas (Cracked!):</h4>
        <div class="info-box" style="font-family: 'Courier New', monospace; font-size: 13px;">
            <strong>Byte 15</strong> = (-16 - 5√óbyte6 + 119√óbyte7 - byte9 - byte10) mod 256<br>
            <strong>Byte 16</strong> = (byte6 - 17√óbyte7 + 2√óbyte10 + 31) mod 256
        </div>

        <h4>‚ö†Ô∏è Important Notes:</h4>
        <ul>
            <li><strong>Bytes 9-10</strong> change with each use - purpose not fully understood</li>
            <li>Dispenser may validate bytes 9-10 as an anti-replay counter</li>
            <li>Bucket sizes: Small = 1 credit, Medium = 2 credits, Large = 3 credits</li>
        </ul>
    </div>

    <script>
        let eepromBytes = [];
        let romData = '';
        let protocol = 'DS1971';
        let selectedByte = 0;

        function parseData() {
            const input = document.getElementById('inputData').value;
            
            // Extract protocol
            const protocolMatch = input.match(/Protocol:\s*(\S+)/i);
            if (protocolMatch) {
                protocol = protocolMatch[1];
            }
            
            // Extract ROM data
            const romMatch = input.match(/Rom Data:\s*([0-9A-Fa-f\s]+)/i);
            if (romMatch) {
                romData = romMatch[1].trim();
            }
            
            // Extract EEPROM data
            let eepromHex = '';
            const eepromMatch = input.match(/Eeprom Data:\s*([0-9A-Fa-f\s]+)/i);
            if (eepromMatch) {
                eepromHex = eepromMatch[1].trim();
            } else {
                // Assume raw hex input
                eepromHex = input.replace(/[^0-9A-Fa-f\s]/g, '').trim();
            }
            
            // Parse hex bytes
            eepromBytes = eepromHex.split(/\s+/).filter(b => b.length > 0).map(b => parseInt(b, 16));
            
            if (eepromBytes.length === 0) {
                alert('Could not parse EEPROM data. Please check input format.');
                return;
            }
            
            displayResults();
        }

        function displayResults() {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('editSection').style.display = 'block';
            document.getElementById('outputSection').style.display = 'block';
            
            document.getElementById('protocol').textContent = protocol;
            document.getElementById('romData').textContent = romData || 'Not provided';
            
            // Calculate credits from bytes 6-7 (little-endian, divide by 20)
            const byte6 = eepromBytes[6] || 0;
            const byte7 = eepromBytes[7] || 0;
            const byte9 = eepromBytes[9] || 0;
            const byte10 = eepromBytes[10] || 0;
            const byte15 = eepromBytes[15] || 0;
            const byte16 = eepromBytes[16] || 0;
            
            const rawValue = (byte7 << 8) | byte6;
            const credits = rawValue / 20;
            
            document.getElementById('usesDisplay').textContent = credits;
            document.getElementById('smallBuckets').textContent = Math.floor(credits);
            document.getElementById('mediumBuckets').textContent = Math.floor(credits / 2);
            document.getElementById('largeBuckets').textContent = Math.floor(credits / 3);
            document.getElementById('usesExplanation').textContent = `Bytes 6-7 = 0x${rawValue.toString(16).toUpperCase().padStart(4, '0')} (${rawValue}) √∑ 20 = ${credits} credits`;
            document.getElementById('newCredits').value = credits;
            
            // Validate checksum (formulas include byte7!)
            const expectedByte15 = (-16 - 5*byte6 + 119*byte7 - byte9 - byte10) & 0xFF;
            const expectedByte16 = (byte6 - 17*byte7 + 2*byte10 + 31) & 0xFF;
            const chk15Valid = byte15 === expectedByte15;
            const chk16Valid = byte16 === expectedByte16;
            
            let checksumHtml = '';
            if (chk15Valid && chk16Valid) {
                checksumHtml = '<span class="success">‚úì Both checksums valid</span>';
            } else {
                checksumHtml = '<span style="color: #ff6b6b;">‚úó Checksum mismatch:</span><br>';
                checksumHtml += `Byte 15: ${byte15.toString(16).toUpperCase().padStart(2, '0')} (expected ${expectedByte15.toString(16).toUpperCase().padStart(2, '0')}) ${chk15Valid ? '‚úì' : '‚úó'}<br>`;
                checksumHtml += `Byte 16: ${byte16.toString(16).toUpperCase().padStart(2, '0')} (expected ${expectedByte16.toString(16).toUpperCase().padStart(2, '0')}) ${chk16Valid ? '‚úì' : '‚úó'}`;
            }
            document.getElementById('checksumStatus').innerHTML = checksumHtml;
            
            // Build byte grid
            const grid = document.getElementById('byteGrid');
            grid.innerHTML = '';
            
            eepromBytes.forEach((byte, index) => {
                const cell = document.createElement('div');
                cell.className = 'byte-cell';
                // Highlight credit counter (bytes 6-7)
                if (index === 6 || index === 7) {
                    cell.style.borderColor = '#ffd93d';
                    cell.style.background = '#2d2a1b';
                }
                // Highlight session counter (bytes 9-10)
                if (index === 9 || index === 10) {
                    cell.style.borderColor = '#00d4aa';
                    cell.style.background = '#1a2d1b';
                }
                // Highlight checksum (bytes 15-16)
                if (index === 15 || index === 16) {
                    cell.style.borderColor = '#ff6b6b';
                    cell.style.background = '#2d1b1b';
                }
                
                cell.innerHTML = `
                    <div class="byte-index">[${index}]</div>
                    <div class="byte-hex">${byte.toString(16).toUpperCase().padStart(2, '0')}</div>
                    <div class="byte-dec">${byte}</div>
                `;
                
                cell.onclick = () => selectByte(index);
                grid.appendChild(cell);
            });
            
            updateOutput();
        }

        function selectByte(index) {
            document.querySelectorAll('.byte-cell').forEach((cell, i) => {
                cell.classList.remove('selected');
                if (i === 0) cell.classList.add('highlight');
            });
            document.querySelectorAll('.byte-cell')[index].classList.add('selected');
            selectedByte = index;
        }

        function setCreditsQuick(credits) {
            document.getElementById('newCredits').value = credits;
            setCredits();
        }

        function setCredits() {
            const credits = parseInt(document.getElementById('newCredits').value);
            if (isNaN(credits) || credits < 0 || credits > 100) {
                alert('Please enter a valid number between 0 and 100');
                return;
            }
            
            // Calculate raw value and set bytes 6-7
            const rawValue = credits * 20;
            eepromBytes[6] = rawValue & 0xFF;        // Low byte
            eepromBytes[7] = (rawValue >> 8) & 0xFF; // High byte
            
            // Recalculate checksums (formulas include byte7!)
            const byte9 = eepromBytes[9] || 0;
            const byte10 = eepromBytes[10] || 0;
            eepromBytes[15] = (-16 - 5*eepromBytes[6] + 119*eepromBytes[7] - byte9 - byte10) & 0xFF;
            eepromBytes[16] = (eepromBytes[6] - 17*eepromBytes[7] + 2*byte10 + 31) & 0xFF;
            
            displayResults();
        }

        function updateOutput() {
            const eepromStr = eepromBytes.map(b => b.toString(16).toUpperCase().padStart(2, '0')).join(' ');
            document.getElementById('outputEeprom').textContent = eepromStr;
            
            const fullFile = `Filetype: Flipper iButton key
Version: 2
Protocol: ${protocol}
Rom Data: ${romData}
Eeprom Data: ${eepromStr}`;
            document.getElementById('outputFull').textContent = fullFile;
        }

        function copyEeprom() {
            const text = document.getElementById('outputEeprom').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showCopyStatus('EEPROM data copied!');
            });
        }

        function copyFull() {
            const text = document.getElementById('outputFull').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showCopyStatus('Full file copied!');
            });
        }

        function downloadFile() {
            const text = document.getElementById('outputFull').textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'range_balls_modified.ibtn';
            a.click();
            URL.revokeObjectURL(url);
            showCopyStatus('File downloaded!');
        }

        function showCopyStatus(message) {
            const status = document.getElementById('copyStatus');
            status.innerHTML = `<span class="success">‚úì ${message}</span>`;
            setTimeout(() => { status.innerHTML = ''; }, 2000);
        }

        function clearAll() {
            document.getElementById('inputData').value = '';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('editSection').style.display = 'none';
            document.getElementById('outputSection').style.display = 'none';
            eepromBytes = [];
        }

        function parseEepromFromText(text) {
            let eepromHex = '';
            const eepromMatch = text.match(/Eeprom Data:\s*([0-9A-Fa-f\s]+)/i);
            if (eepromMatch) {
                eepromHex = eepromMatch[1].trim();
            } else {
                eepromHex = text.replace(/[^0-9A-Fa-f\s]/g, '').trim();
            }
            return eepromHex.split(/\s+/).filter(b => b.length > 0).map(b => parseInt(b, 16));
        }

        function parseRomFromText(text) {
            const romMatch = text.match(/Rom Data:\s*([0-9A-Fa-f\s]+)/i);
            return romMatch ? romMatch[1].trim() : '';
        }

        function compareButtons() {
            const textA = document.getElementById('compareA').value;
            const textB = document.getElementById('compareB').value;
            
            const bytesA = parseEepromFromText(textA);
            const bytesB = parseEepromFromText(textB);
            const romA = parseRomFromText(textA);
            const romB = parseRomFromText(textB);
            
            if (bytesA.length === 0 || bytesB.length === 0) {
                alert('Could not parse EEPROM data from one or both inputs.');
                return;
            }

            let html = '';
            
            // ROM comparison
            const sameButton = romA === romB;
            html += `<div class="info-box">
                <strong>ROM Comparison:</strong> ${sameButton ? 
                    '<span class="success">‚úì Same iButton</span>' : 
                    '<span style="color: #ff6b6b;">‚úó Different iButtons</span>'}<br>
                <span style="font-size: 12px; color: #888;">A: ${romA || 'N/A'}<br>B: ${romB || 'N/A'}</span>
            </div>`;

            // EEPROM diff
            html += '<div class="info-box"><strong>EEPROM Differences:</strong>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-family: monospace;">';
            html += '<tr style="background: #0f0f23;"><th style="padding: 6px; border: 1px solid #333;">Byte</th><th style="padding: 6px; border: 1px solid #333;">Button A</th><th style="padding: 6px; border: 1px solid #333;">Button B</th><th style="padding: 6px; border: 1px solid #333;">Diff</th></tr>';
            
            let diffCount = 0;
            const maxLen = Math.max(bytesA.length, bytesB.length);
            
            for (let i = 0; i < maxLen; i++) {
                const a = bytesA[i] !== undefined ? bytesA[i] : null;
                const b = bytesB[i] !== undefined ? bytesB[i] : null;
                const isDiff = a !== b;
                
                if (isDiff) {
                    diffCount++;
                    const aHex = a !== null ? a.toString(16).toUpperCase().padStart(2, '0') : '--';
                    const bHex = b !== null ? b.toString(16).toUpperCase().padStart(2, '0') : '--';
                    const aDec = a !== null ? a : '-';
                    const bDec = b !== null ? b : '-';
                    const diff = (a !== null && b !== null) ? (b - a) : '-';
                    const diffStr = (typeof diff === 'number' && diff > 0) ? `+${diff}` : diff;
                    
                    html += `<tr style="background: #2d2a1b;">
                        <td style="padding: 6px; border: 1px solid #333; color: #ffd93d;">[${i}]</td>
                        <td style="padding: 6px; border: 1px solid #333;">${aHex} (${aDec})</td>
                        <td style="padding: 6px; border: 1px solid #333;">${bHex} (${bDec})</td>
                        <td style="padding: 6px; border: 1px solid #333; color: #ff6b6b;">${diffStr}</td>
                    </tr>`;
                }
            }
            
            html += '</table>';
            html += `<p style="margin-top: 10px; color: #888;">${diffCount} bytes differ out of ${maxLen}</p>`;
            html += '</div>';

            // Analysis hints
            if (sameButton) {
                html += `<div class="info-box" style="border-left: 4px solid #00d4aa;">
                    <strong>üí° Same Button Analysis:</strong><br>
                    Look for bytes that decreased - likely the uses counter.<br>
                    Look for bytes that changed together - likely checksum.
                </div>`;
            } else {
                html += `<div class="info-box" style="border-left: 4px solid #ffd93d;">
                    <strong>üí° Different Button Analysis:</strong><br>
                    Bytes that are SAME may be: facility ID, system config<br>
                    Bytes that DIFFER may be: unique ID, uses, purchase amount, checksum
                </div>`;
            }

            document.getElementById('compareResults').innerHTML = html;
        }

        // Auto-parse on load if there's default data
        window.onload = function() {
            if (document.getElementById('inputData').value.trim()) {
                parseData();
            }
        };
    </script>
</body>
</html>
